[{"D:\\Programación\\Master\\FIS\\frontend\\src\\index.js":"1","D:\\Programación\\Master\\FIS\\frontend\\src\\App.js":"2","D:\\Programación\\Master\\FIS\\frontend\\src\\reportWebVitals.js":"3","D:\\Programación\\Master\\FIS\\frontend\\src\\pages\\home\\Home.js":"4","D:\\Programación\\Master\\FIS\\frontend\\src\\pages\\messenger\\Messenger.js":"5","D:\\Programación\\Master\\FIS\\frontend\\src\\services\\messenger.js":"6","D:\\Programación\\Master\\FIS\\frontend\\src\\services\\client.js":"7","D:\\Programación\\Master\\FIS\\frontend\\src\\components\\messenger\\message\\Message.js":"8","D:\\Programación\\Master\\FIS\\frontend\\src\\components\\messenger\\room\\Room.js":"9","D:\\Programación\\Master\\FIS\\frontend\\src\\services\\request.js":"10","D:\\Programación\\Master\\FIS\\frontend\\src\\components\\navbar\\NavBar.js":"11","D:\\Programación\\Master\\FIS\\frontend\\src\\components\\navbar\\MenuDrawer.js":"12"},{"size":545,"mtime":1610115876278,"results":"13","hashOfConfig":"14"},{"size":1295,"mtime":1610115697245,"results":"15","hashOfConfig":"14"},{"size":377,"mtime":1610039272997,"results":"16","hashOfConfig":"14"},{"size":355,"mtime":1610039600916,"results":"17","hashOfConfig":"14"},{"size":9585,"mtime":1610039600917,"results":"18","hashOfConfig":"14"},{"size":1169,"mtime":1610039272998,"results":"19","hashOfConfig":"14"},{"size":652,"mtime":1610039600918,"results":"20","hashOfConfig":"14"},{"size":399,"mtime":1610039272992,"results":"21","hashOfConfig":"14"},{"size":993,"mtime":1610039272995,"results":"22","hashOfConfig":"14"},{"size":1220,"mtime":1610039272999,"results":"23","hashOfConfig":"14"},{"size":6611,"mtime":1610116047963,"results":"24","hashOfConfig":"14"},{"size":3037,"mtime":1610116059856,"results":"25","hashOfConfig":"14"},{"filePath":"26","messages":"27","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},"g3p4qu",{"filePath":"28","messages":"29","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"30","messages":"31","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"33","messages":"34","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"35","messages":"36","errorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"37","usedDeprecatedRules":"32"},{"filePath":"38","messages":"39","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"40","messages":"41","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"42","messages":"43","errorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"44","usedDeprecatedRules":"32"},{"filePath":"45","messages":"46","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"47","messages":"48","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":"32"},{"filePath":"49","messages":"50","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},{"filePath":"51","messages":"52","errorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0},"D:\\Programación\\Master\\FIS\\frontend\\src\\index.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\App.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\reportWebVitals.js",[],["53","54"],"D:\\Programación\\Master\\FIS\\frontend\\src\\pages\\home\\Home.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\pages\\messenger\\Messenger.js",["55"],"import React from \"react\";\r\nimport { Link, withRouter } from \"react-router-dom\";\r\nimport \"./Messenger.css\";\r\nimport { io } from \"socket.io-client\";\r\nimport Message from \"../../components/messenger/message/Message\";\r\nimport Room from \"../../components/messenger/room/Room\";\r\nimport * as MessengerServices from \"../../services/messenger\";\r\nimport * as ClientService from \"../../services/client\";\r\n\r\nclass Messenger extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.roomId = window.location.pathname.replace('/chat', '').replace('/', '') || undefined\r\n    // forbidden if is not your user\r\n    if (this.roomId !== undefined && \r\n      (\r\n        (Number(this.roomId.split('-')[0]) !== ClientService.getJWT().data.userId && Number(this.roomId.split('-')[1]) !== ClientService.getJWT().data.userId) \r\n        || \r\n        Number(this.roomId.split('-')[0]) === Number(this.roomId.split('-')[1])\r\n        )\r\n      ) {\r\n      alert('El destinatario no existe');\r\n      this.props.history.push(\"/chat\");\r\n    }\r\n    \r\n    this.state = { selectedRoomId: this.roomId, rooms: undefined, message: undefined };\r\n    this.content = undefined\r\n\r\n    this.websocket = this.websocket.bind(this);\r\n    this.getRooms = this.getRooms.bind(this);\r\n    this.getMessage = this.getMessage.bind(this);\r\n    this.handleChange = this.handleChange.bind(this);\r\n    this.sendMessage = this.sendMessage.bind(this);\r\n    this.changeRoom = this.changeRoom.bind(this);\r\n    this.deleteRoom = this.deleteRoom.bind(this);\r\n    this.modifyRoomName = this.modifyRoomName.bind(this);\r\n  }\r\n\r\n  async componentDidMount() {\r\n    if (this.roomId !== undefined) {\r\n      this.setState({ userInfo: await this.getUserInfo(this.getUserDifferent(this.roomId))}) // not work on constructor\r\n    } else {\r\n      this.setState({ userInfo: undefined})\r\n    }\r\n      \r\n \r\n    await this.getRooms();\r\n    this.websocket();\r\n\r\n    // scroll bottom\r\n  }\r\n\r\n  async getUserInfo(userId){\r\n    return await MessengerServices.getUserInfo(userId)\r\n  }\r\n\r\n  websocket() {\r\n    this.socket = io(\r\n      process.env.REACT_APP_ENDPOINT_API_MESSENGER + \"/chat\",\r\n      {\r\n        forceNew: false,\r\n        transports: [\"websocket\"],\r\n        query: {\r\n          token: ClientService.getJWT().token,\r\n        },\r\n      }\r\n    );\r\n\r\n    this.socket.on(\"private_message\", async (data) => {\r\n      if (this.state.selectedRoomId === data.roomId) {\r\n        // add message and room\r\n        let room = this.state.rooms.find((x) => x.roomId === data.roomId);\r\n        if (room === undefined && this.state.message === undefined) {\r\n          await this.getRooms();\r\n        } else {\r\n          let message = this.state.message;\r\n          message.messages.push({\r\n            content: data.content,\r\n            userId: data.userId,\r\n          });\r\n\r\n          // new message to false\r\n          room.newMessage = false;\r\n\r\n          this.setState({ message: message, rooms: this.state.rooms });\r\n        }\r\n      } else {\r\n        // new message to true\r\n        let room = this.state.rooms.find((x) => x.roomId === data.roomId);\r\n        if (room !== undefined) {\r\n          room.newMessage = true;\r\n          this.setState({ rooms: this.state.rooms });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  async getRooms() {\r\n    try {\r\n      let rooms = await MessengerServices.getRooms();\r\n      rooms.map((x) => (x.newMessage = false));\r\n      this.setState({ rooms: rooms });\r\n\r\n      // if exist room, get the once\r\n      if (rooms.length > 0 && this.state.selectedRoomId === undefined) {\r\n        await this.getMessage(rooms[0].roomId);\r\n\r\n        // select once room if I access by /chat url\r\n        this.setState({selectedRoomId: rooms[0].roomId, userInfo: await this.getUserInfo(this.getUserDifferent(rooms[0].roomId))})\r\n      } else if(rooms.length > 0 && this.state.selectedRoomId !== undefined) {\r\n        await this.getMessage(this.state.selectedRoomId);\r\n      } else if(rooms.length === 0) {\r\n        this.setState({message: undefined, rooms: undefined})\r\n      }\r\n    } catch (error) {\r\n      console.log(error);\r\n    }\r\n  }\r\n\r\n  async getMessage(roomId) {\r\n    try {\r\n      let message = await MessengerServices.getMessages(roomId);\r\n      console.log(message)\r\n      this.setState({ message: message });\r\n    } catch (error) {\r\n      if(error.response.data.error == 'Invalid data'){\r\n        alert('El producto o el destinatario no existe');\r\n        this.props.history.push(\"/chat\");\r\n      }\r\n    }\r\n  }\r\n\r\n  handleChange(event) {\r\n    this.content = event.target.value;\r\n  }\r\n\r\n  getUserDifferent(roomId) {\r\n    return (roomId.split('-')[0]+\"\"+roomId.split('-')[1]).replace(ClientService.getJWT().data.userId, '')\r\n  }\r\n  async sendMessage() {\r\n    // not undefined content\r\n    if(this.content === undefined || this.content === \"\") return;\r\n\r\n    this.socket.emit(\"send_message\", {\r\n      userId: this.getUserDifferent(this.state.selectedRoomId),\r\n      content: this.content,\r\n      roomId: this.state.selectedRoomId,\r\n    });\r\n    \r\n    // print message\r\n    if (this.state.message !== undefined) {\r\n      this.state.message.messages.push({\r\n        content: this.content,\r\n        userId: this.getUserDifferent(this.state.selectedRoomId),\r\n      })\r\n      this.setState({message: this.state.message})\r\n    }\r\n    // new conversation\r\n    if (this.state.message === undefined || this.state.message.messages === []) await this.getRooms();\r\n\r\n    // update last message\r\n    let room = this.state.rooms.find((x) => x.roomId === this.state.selectedRoomId);\r\n    room.lastMessage = this.content;\r\n    this.setState({ rooms: this.state.rooms });\r\n\r\n    // scroll bottom\r\n    document.getElementById(\"messages\").scrollTop = 10000000000;\r\n  }\r\n\r\n  async changeRoom(roomId) {\r\n    await this.getMessage(roomId);\r\n\r\n    // new message to false\r\n    let room = this.state.rooms.find((x) => x.roomId === roomId);\r\n    room.newMessage = false;\r\n\r\n    this.setState({selectedRoomId: roomId, userInfo: await this.getUserInfo(this.getUserDifferent(roomId)), rooms: this.state.rooms})\r\n\r\n    // scroll bottom\r\n    document.getElementById(\"messages\").scrollTop = 10000000000;\r\n  }\r\n\r\n  async deleteRoom(roomId) {\r\n    try {\r\n      await MessengerServices.removeRoom(roomId);\r\n      this.setState({selectedRoomId: undefined, userInfo: undefined})\r\n      await this.getRooms();\r\n    } catch (error) {\r\n      console.log(error)\r\n    }\r\n  }\r\n\r\n  async modifyRoomName(roomId) {\r\n    let message = this.state.message\r\n    let roomName = prompt(\"Please enter your name\", message.roomName);\r\n\r\n    try {\r\n      await MessengerServices.modifyRoomName(roomId, {roomName: roomName});\r\n      let rooms = await MessengerServices.getRooms(roomId);\r\n      this.setState({rooms: rooms})\r\n    } catch (error) {\r\n      console.log(error)\r\n    }\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <>\r\n        <link\r\n          rel=\"stylesheet prefetch\"\r\n          href=\"https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css\"\r\n        ></link>\r\n        <link\r\n          rel=\"stylesheet\"\r\n          href=\"https://pro.fontawesome.com/releases/v5.10.0/css/all.css\"\r\n      />\r\n        <div id=\"frame\">\r\n          <div id=\"sidepanel\">\r\n            <div id=\"bottom-bar\">\r\n              <button>\r\n                <i class=\"far fa-newspaper\"></i>{\" \"}\r\n                <span>\r\n                  <Link class=\"link\" to=\"/\">\r\n                    Ver productos\r\n                  </Link>\r\n                </span>\r\n              </button>\r\n            </div>\r\n            <div id=\"contacts\">\r\n              <ul>\r\n                {this.state.rooms !== undefined &&\r\n                  this.state.rooms.map((data, i) => (\r\n                    <Room\r\n                      selectedRoomId={\r\n                        data.roomId === this.state.selectedRoomId\r\n                          ? \"selected \"\r\n                          : \"\"\r\n                      }\r\n                      data={data}\r\n                      key={i}\r\n                      changeRoom={this.changeRoom}\r\n                      deleteRoom={this.deleteRoom}\r\n                      modifyRoomName={this.modifyRoomName}\r\n                    />\r\n                  ))}\r\n              </ul>\r\n            </div>\r\n          </div>\r\n          <div class=\"content\">\r\n            <div class=\"contact-profile\">\r\n              {this.state.userInfo !== undefined && (\r\n                <>\r\n                  <img src={this.state.userInfo.image} alt=\"\" />\r\n                  <p>{this.state.userInfo.userName}</p>\r\n                </>\r\n              )}\r\n            </div>\r\n            <div class=\"messages\" id=\"messages\">\r\n              <ul>\r\n                {this.state.message !== undefined &&\r\n                  this.state.message.messages.map((data, i) => (\r\n                    <Message data={data} key={i} />\r\n                  ))}\r\n              </ul>\r\n            </div>\r\n            <div class=\"message-input\">\r\n              <div class=\"wrap\">\r\n                {this.state.selectedRoomId !== undefined ?\r\n                  <>\r\n                    <input\r\n                      type=\"text\"\r\n                      placeholder=\"Write your message...\"\r\n                      onChange={this.handleChange}\r\n                    />\r\n                    <button class=\"submit\" onClick={() => this.sendMessage()}>\r\n                      <i class=\"fa fa-paper-plane\" aria-hidden=\"true\"></i>\r\n                    </button>\r\n                  </>\r\n                : ''}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </>\r\n    );\r\n  }\r\n}\r\n\r\nexport default withRouter(Messenger)","D:\\Programación\\Master\\FIS\\frontend\\src\\services\\messenger.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\services\\client.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\components\\messenger\\message\\Message.js",["56"],"import React from \"react\";\r\nimport \"./Message.css\";\r\nimport * as ClientService from \"../../../services/client\";\r\n\r\nexport default class Message extends React.Component {\r\n  render() {\r\n    return (\r\n      <>\r\n        <li class={ClientService.getJWT().data.userId == this.props.data.userId ? \"sent\" : \"replies\"}>\r\n          <p>{this.props.data.content}</p>\r\n        </li>\r\n      </>\r\n    );\r\n  }\r\n}\r\n","D:\\Programación\\Master\\FIS\\frontend\\src\\components\\messenger\\room\\Room.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\services\\request.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\components\\navbar\\NavBar.js",[],"D:\\Programación\\Master\\FIS\\frontend\\src\\components\\navbar\\MenuDrawer.js",[],{"ruleId":"57","replacedBy":"58"},{"ruleId":"59","replacedBy":"60"},{"ruleId":"61","severity":1,"message":"62","line":127,"column":36,"nodeType":"63","messageId":"64","endLine":127,"endColumn":38},{"ruleId":"61","severity":1,"message":"62","line":9,"column":55,"nodeType":"63","messageId":"64","endLine":9,"endColumn":57},"no-native-reassign",["65"],"no-negated-in-lhs",["66"],"eqeqeq","Expected '===' and instead saw '=='.","BinaryExpression","unexpected","no-global-assign","no-unsafe-negation"]